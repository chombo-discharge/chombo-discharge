/*!
  @file   air6_mc8.H
  @brief  6-species (3/3 charged/excited) and 8-photon model for air
  @author Robert Marskar
  @date   Feb. 2018
*/

#ifndef _AIR6_MC8_
#define _AIR6_MC8_

#include "network_kinetics.H"
#include "lookup_table.H"

class air6_mc8 : public network_kinetics {
public:

  class electron;
  class M_plus;
  class M_minus;
  class N2_c4v0;
  class N2_c4v1;
  class N2_b1v1;

  class phot_c4v0_X1v0;
  class phot_c4v0_X1v1;
  class phot_c4v1_X1v0;
  class phot_c4v1_X1v1;
  class phot_c4v1_X1v2;
  class phot_c4v1_X1v3;
  class phot_b1v1_X1v0;
  class phot_b1v1_X1v1;

  air6_mc8();
  ~air6_mc8();
  

  void advance_reaction_network(Vector<Real>&          a_particle_sources,
				Vector<Real>&          a_photon_sources,
				const Vector<Real>     a_particle_densities,
				const Vector<RealVect> a_particle_gradients,
				const Vector<Real>     a_photon_densities,
				const RealVect         a_E,
				const RealVect         a_pos,
				const Real             a_dx,
				const Real             a_dt,
				const Real             a_time,
				const Real             a_kappa) const;


  Vector<Real> compute_cdr_diffusion_coefficients(const Real         a_time,
						  const RealVect     a_pos,
						  const RealVect     a_E,
						  const Vector<Real> a_cdr_densities) const;
  
  Vector<RealVect> compute_cdr_velocities(const Real         a_time,
					  const RealVect     a_pos,
					  const RealVect     a_E,
					  const Vector<Real> a_cdr_densities) const;
  
  Vector<Real> compute_cdr_domain_fluxes(const Real           a_time,
					 const RealVect       a_pos,
					 const int            a_dir,
					 const Side::LoHiSide a_side,
					 const RealVect       a_E,
					 const Vector<Real>   a_cdr_densities,
					 const Vector<Real>   a_cdr_velocities,
					 const Vector<Real>   a_cdr_gradients,
					 const Vector<Real>   a_rte_fluxes,
					 const Vector<Real>   a_extrap_cdr_fluxes) const;
  
  Vector<Real> compute_cdr_electrode_fluxes(const Real         a_time,
					    const RealVect     a_pos,
					    const RealVect     a_normal,
					    const RealVect     a_E,
					    const Vector<Real> a_cdr_densities,
					    const Vector<Real> a_cdr_velocities,
					    const Vector<Real> a_cdr_gradients,
					    const Vector<Real> a_rte_fluxes,
					    const Vector<Real> a_extrap_cdr_fluxes) const;

  Vector<Real> compute_cdr_dielectric_fluxes(const Real         a_time,
					     const RealVect     a_pos,
					     const RealVect     a_normal,
					     const RealVect     a_E,
					     const Vector<Real> a_cdr_densities,
					     const Vector<Real> a_cdr_velocities,
					     const Vector<Real> a_cdr_gradients,
					     const Vector<Real> a_rte_fluxes,
					     const Vector<Real> a_extrap_cdr_fluxes) const;

  Real initial_sigma(const Real a_time, const RealVect a_pos) const;

protected:

  static std::string s_bolsig_mobility;
  static std::string s_bolsig_diffco;
  static std::string s_bolsig_alpha;
  static std::string s_bolsig_eta;

  enum source_comp{
    ssa = 0,
    tau = 1,
    rre = 2
  };

  source_comp m_scomp;

  std::string m_transport_file;

  // Tables built from BOLSIG+
  lookup_table m_e_mobility;
  lookup_table m_e_diffco;
  lookup_table m_e_alpha;
  lookup_table m_e_eta;

  Vector<int> m_wallbc; // Wall boundary conditions

  bool m_mobile_electrons;    // Mobile electrons or not
  bool m_mobile_ions;         // Mobile ions or not
  bool m_diffusive_ions;      // Diffusive ions or not
  bool m_diffusive_electrons; // Diffusive electrons or not
  
  Real m_rng_seed;
  Real m_poiss_exp_swap;

  // Random number generator and some distributions
  std::mt19937_64*                      m_rng; 
  std::uniform_real_distribution<Real>* m_udist01;
  std::uniform_real_distribution<Real>* m_udist11;
  std::normal_distribution<Real>        m_gauss;

  int m_uniform_entries; // # of entries in uniform-made BOLSIG tables

  // Indices for various species
  int m_elec_idx; // Electrons
  int m_plus_idx; // Positive ions
  int m_minu_idx; // Negative ions
  int m_c4v0_idx; // N2 c4(v=0) excited state
  int m_c4v1_idx; // N2 c4(v=1) excited state
  int m_b1v1_idx; // N2 b1(v=0) excited state

  // Indicates for various photons
  int m_c4v0_X1v0_idx; // Transition c4(v=0) -> X1(v=0)
  int m_c4v0_X1v1_idx; // Transition c4(v=0) -> X1(v=0)
  int m_c4v1_X1v0_idx; // Transition c4(v=1) -> X1(v=0)
  int m_c4v1_X1v1_idx; // Transition c4(v=1) -> X1(v=1)
  int m_c4v1_X1v2_idx; // Transition c4(v=1) -> X1(v=2)
  int m_c4v1_X1v3_idx; // Transition c4(v=1) -> X1(v=3)
  int m_b1v1_X1v0_idx; // Transition b1(v=1) -> X1(v=0)
  int m_b1v1_X1v1_idx; // Transition b1(v=1) -> X1(v=1)

  Real m_townsend2_electrode;           // 2nd Townsend coefficient on electrodes
  Real m_townsend2_dielectric;          // 2nd Townsend coefficient on dielectrics
  Real m_electrode_quantum_efficiency;  // Quantum yield on electrodes
  Real m_dielectric_quantum_efficiency; // Quantum yield on dielectircs
  
  Real m_N;      // Neutral number density
  Real m_p;      // Pressure
  Real m_T;      // Temperature
  Real m_O2frac; // O2 fraction
  Real m_N2frac; // N2 fraction
  Real m_pO2;    // Partial O2 pressure

  // Excitation efficiencies for various states
  Real m_c4v0_exc_eff;
  Real m_c4v1_exc_eff;
  Real m_b1v1_exc_eff;

  // Lifetimes for various transitions
  Real m_c4v0_X1v0_tau_r; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v0_X1v1_tau_r; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v1_X1v0_tau_r; // Transition c4(v=1) -> X1(v=0)
  Real m_c4v1_X1v1_tau_r; // Transition c4(v=1) -> X1(v=1)
  Real m_c4v1_X1v2_tau_r; // Transition c4(v=1) -> X1(v=2)
  Real m_c4v1_X1v3_tau_r; // Transition c4(v=1) -> X1(v=3)
  Real m_b1v1_X1v0_tau_r; // Transition b1(v=1) -> X1(v=0)
  Real m_b1v1_X1v1_tau_r; // Transition b1(v=1) -> X1(v=1)

  // Predissociation lifetimes for various transitions
  Real m_c4v0_tau_p; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v1_tau_p; // Transition c4(v=1) -> X1(v=2)
  Real m_b1v1_tau_p; // Transition b1(v=1) -> X1(v=1)

  // Quenching lifetimes for various transitions
  Real m_c4v0_X1v0_tau_q; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v0_X1v1_tau_q; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v1_X1v0_tau_q; // Transition c4(v=1) -> X1(v=0)
  Real m_c4v1_X1v1_tau_q; // Transition c4(v=1) -> X1(v=1)
  Real m_c4v1_X1v2_tau_q; // Transition c4(v=1) -> X1(v=2)
  Real m_c4v1_X1v3_tau_q; // Transition c4(v=1) -> X1(v=3)
  Real m_b1v1_X1v0_tau_q; // Transition b1(v=1) -> X1(v=0)
  Real m_b1v1_X1v1_tau_q; // Transition b1(v=1) -> X1(v=1)

  // Photoionization efficiency for various transitions
  Real m_c4v0_X1v0_photoi_eff; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v0_X1v1_photoi_eff; // Transition c4(v=0) -> X1(v=0)
  Real m_c4v1_X1v0_photoi_eff; // Transition c4(v=1) -> X1(v=0)
  Real m_c4v1_X1v1_photoi_eff; // Transition c4(v=1) -> X1(v=1)
  Real m_c4v1_X1v2_photoi_eff; // Transition c4(v=1) -> X1(v=2)
  Real m_c4v1_X1v3_photoi_eff; // Transition c4(v=1) -> X1(v=3)
  Real m_b1v1_X1v0_photoi_eff; // Transition b1(v=1) -> X1(v=0)
  Real m_b1v1_X1v1_photoi_eff; // Transition b1(v=1) -> X1(v=1)

  Real m_pq;         // Quenching pressure
  Real m_exc_eff;    // Excitation efficiency
  Real m_photoi_eff; // Photoionization efficiency
  Real m_particle_w; // Particle weights
  Real m_exc_tau;    // Lifetime for excited state
  Real m_quench_tau; // Lifetime for excited state

  Real m_ion_mobility;  // Ion mobility
  Real m_ion_diffusion; // Ion diffusion coefficient

  Real ran01() const;
  Real ran11() const;
  RealVect random_gaussian();
  RealVect random_direction();
#if CH_SPACEDIM==2
  RealVect random_direction2D();
#elif CH_SPACEDIM==3
  RealVect random_direction3D();
#endif

  void read_file_entries(lookup_table& a_table, const std::string a_string);
  void parse_transport_file();
  void parse_transport();
  void parse_gas_params();
  void parse_electron_mobility();
  void parse_electron_diffco();
  void parse_alpha();
  void parse_eta();
  void parse_photoi();
  void parse_see();
  void parse_domain_bc();
  void parse_chemistry();
  void parse_initial_particles();
  void instantiate_species();
  void init_rng();
  void add_uniform_particles(List<Particle>& a_particles, const int a_num, const Real a_weight);
  void add_gaussian_particles(List<Particle>& a_particles,
			      const int       a_num,
			      const Real      a_weight,
			      const Real      a_rad,
			      const RealVect  a_center);

  
  inline int poisson_reaction(const Real a_propensity, const Real a_dt) const;
  inline int binomial_trials(const int a_trials, const Real a_p) const;


  Vector<Real> compute_cdr_fluxes(const Real         a_time,
				  const RealVect     a_pos,
				  const RealVect     a_normal,
				  const RealVect     a_E,
				  const Vector<Real> a_cdr_densities,
				  const Vector<Real> a_cdr_velocities,
				  const Vector<Real> a_cdr_gradients,
				  const Vector<Real> a_rte_fluxes,
				  const Vector<Real> a_extrap_cdr_fluxes,
				  const Real         a_townsend2,
				  const Real         a_quantum_efficiency) const;

  // Tau leaping method
  void network_tau(Vector<Real>&          a_particle_sources,
		   Vector<Real>&          a_photon_sources,
		   const Vector<Real>     a_particle_densities,
		   const Vector<RealVect> a_particle_gradients,
		   const Vector<Real>     a_photon_densities,
		   const RealVect         a_E,
		   const RealVect         a_pos,
		   const Real             a_dx,
		   const Real             a_dt,
		   const Real             a_time,
		   const Real             a_kappa) const;

  // stochastic simulation algorithm
  void network_ssa(Vector<Real>&          a_particle_sources,
		   Vector<Real>&          a_photon_sources,
		   const Vector<Real>     a_particle_densities,
		   const Vector<RealVect> a_particle_gradients,
		   const Vector<Real>     a_photon_densities,
		   const RealVect         a_E,
		   const RealVect         a_pos,
		   const Real             a_dx,
		   const Real             a_dt,
		   const Real             a_time,
		   const Real             a_kappa) const;

  // stochastic simulation algorithm
  void network_rre(Vector<Real>&          a_particle_sources,
		   Vector<Real>&          a_photon_sources,
		   const Vector<Real>     a_particle_densities,
		   const Vector<RealVect> a_particle_gradients,
		   const Vector<Real>     a_photon_densities,
		   const RealVect         a_E,
		   const RealVect         a_pos,
		   const Real             a_dx,
		   const Real             a_dt,
		   const Real             a_time,
		   const Real             a_kappa) const;


  
#include "CD_NamespaceFooter.H"

#endif
